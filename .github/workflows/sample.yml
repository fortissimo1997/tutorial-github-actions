name: sample
on:
  push:
    branches:
      - master
jobs:
  prepare:
    name: prepare
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          TZ: UTC
          MYSQL_DATABASE: sample
          MYSQL_USER: sample_user
          MYSQL_PASSWORD: PASSWORD
          MYSQL_ROOT_PASSWORD: password
        options: --health-cmd "mysqladmin ping -uroot -ppassword" --health-interval 20s --health-timeout 10s --health-retries 10
      redis:
        image: redis:4.0-alpine
        ports:
          - 6379:6379
        env:
          TZ: UTC
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 10
    steps:
      - name: create table
        run: |
          mysql -h 127.0.0.1 -usample_user -pPASSWORD -e "use sample; create table dummy_table (id int(11) not null auto_increment, title varchar(255) not null, primary key (id))"
      - name: insert dummy data
        run: |
          mysql -h 127.0.0.1 -usample_user -pPASSWORD -e "use sample; insert into dummy_table (title) values ('foo'), ('bar'), ('baz')"
      - name: select dummy data
        run: |
          mysql -h 127.0.0.1 -usample_user -pPASSWORD -e "use sample; select * from dummy_table"
      - name: debug
        run: docker container ls
      - name: restart mysql
        run: docker restart $(docker container ls | grep mysql | awk '{print $1}')
      - name: find sql file
        run: find . -name setup.sql
      - name: ls files
        run: ls -a